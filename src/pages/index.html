<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        *::-webkit-scrollbar {
            width: 12px;
            height: 12px;
            background: transparent;
        }
        *::-webkit-scrollbar-thumb {
            background: rgba(70, 70, 70, 0.2);
        }
        .navlist-sublist::-webkit-scrollbar {
            width: 8px;
        }

        input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 15px;
        height: 15px;
        border: 2px solid #84beff;
        border-radius: 2px;
        outline: none;
        cursor: pointer;
        /* transition: all 0.1s; */
        }

        /* Style the checked state */
        input[type="checkbox"]:checked {
        background-color: #84beff;
        }

        /* Style the label */
        label {
        margin-left: 5px;
        cursor: pointer;
        }
        
        .context-menu ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        }

        .context-menu li {
        cursor: pointer;
        padding: 5px;
        }

        .context-menu li:hover {
        background-color: #ccc;
        }
        .contextMenu li {
            font-size: 12px;
            padding: 6px;
            padding-left: 14px;
        }
        .contextMenu {
            animation: none;
            z-index: 1000;
        }

    </style>
    <style id="configurableStyle"></style>
    <style id="configurableFont"></style>
    <title>NoteFinity</title>
</head>
<body class="rounded-md select-none">
    <header class="w-full flex flex-col fixed left-0 top-0 z-[1000]">
        <div class="flex justify-between items-center w-full h-8 px-2" id="headerPane" style="-webkit-app-region: drag;">

        </div>
        <ul class="w-full h-6 flex items-center justify-start" id="headerNavigation">
            <button class="navlist-item">
                <span>File</span>
                <ul class="navlist-sublist w-40 ml-1">
                    <li onclick="tabNewFile()">New (Ctrl+N)</li>
                    <li onclick="fileAction('openfile')">Open (Ctrl+O)</li>
                    <li onclick="openFolder()">Open Folder</li>
                    <li onclick="openModal('openrecent')">Open Recent Files</li>
                    <li onclick="fileAction('savefile')">Save (Ctrl+S)</li>
                    <li onclick="fileAction('saveas')">Save as (Ctrl+Shift+S)</li>
                    <li onclick="fileAction('savecopyas')">Save a Copy As</li>
                    <li onclick="fileAction('saveall')">Save All</li>
                    <hr>
                    <li onclick="renameFile()">Rename</li>
                    <hr>
                    <li onclick="tabitemClose(notefinity.activatedEditor);">Close (Ctrl+W)</li>
                    <li onclick="closeAllFiles()">Close All</li>
                    <li onclick="closeAllButActiveDocument()">Close All but Active Document</li>
                    <li onclick="closeToTheLeft()">Close All to the left</li>
                    <li onclick="closeToTheRight()">Close All to the right</li>
                    <hr>
                    <li onclick="appAction('exit')">Exit</li>
                </ul>
            </button>
            <button class="navlist-item">
                <span>Edit</span>
                <ul class="navlist-sublist w-40">
                    <li onclick="editTab.undo()">Undo (Ctrl+Z)</li>
                    <li onclick="editTab.redo()">Redo (Ctrl+Y)</li>
                    <hr>
                    <li onclick="reloadFileContents()">Reload (Ctrl+R)</li>
                    <hr>
                    <li onclick="editTab.openFindPanel();">Find (Ctrl+F)</li>
                    <li onclick="editTab.openFindReplacePanel();">Replace (Ctrl+H)</li>
                    <hr>
                    <li onclick="openModal('copytoclipboard')">Copy to Clipboard</li>
                    <hr>
                    <li onclick="insertDate()">Time/Date (F5)</li>
                    <hr>
                    <li onclick="convertCaseTo()">Convert Case to</li>
                    <li onclick="removeUnnecessarySpaces()">Remove Unnecessary Spaces</li>
                    <li onclick="deleteEmptyLines()">Delete Empty Lines</li>
                    <li onclick="sanitizeHTML()">Sanitize HTML</li>
                    <hr>
                    <li style="display: flex; justify-content: space-between;" onclick="toggleReadOnly(this)">Read Only <input type="checkbox"></li>
                </ul>
            </button>
            <button class="navlist-item">
                <span>View</span>
                <ul class="navlist-sublist w-40">
                    <li style="display: flex; justify-content: space-between;" id="navWordWrap">Word Wrap <input type="checkbox"></li>
                    <hr>
                    <li style="display: flex; justify-content: space-between;" onclick="viewAlwaysOnTop(this)">Always on Top <input type="checkbox"></li>
                    <li onclick="toggleFullScreenMode()">Toggle Full Screen Mode (F11)</li>
                    <li onclick="temporarilyHide()">Temporarily Hide</li>
                    <hr>
                    <li onclick="openModal('chooselanguage')">Syntax Highlighting</li>
                    <hr>
                    <li onclick="viewInApplication()">View File in Application</li>
                </ul>
            </button>
            <button class="navlist-item">
                <span>Options</span>
                <ul class="navlist-sublist w-[9rem]">
                    <li onclick="fetchFromInternet()">Fetch From Internet</li>
                    <li onclick="openModal('minifier')">Code Minifier</li>
                    <li onclick="openModal('texttospeech')">Text to Speech</li>
                    <li onclick="previewMarkdown()">Preview Markdown</li>
                    <hr>
                    <li style="display: flex; justify-content: space-between;" id="navAutoSave">Auto Save <input type="checkbox"></li>
                </ul>
            </button>
            <button class="navlist-item">
                <span>Customization</span>
                <ul class="navlist-sublist w-32">
                    <li onclick="openModal('frame')">Frame</li>
                    <li onclick="openModal('theme')">Theme</li>
                    <li onclick="openModal('textbox')">Textbox</li>
                    <li onclick="openModal('fonts')">Fonts</li>
                </ul>
            </button>
            <button class="navlist-item">
                <span>Help</span>
                <ul class="navlist-sublist w-36">
                    <li onclick="openAboutNoteFinity()">About NoteFinity</li>
                    <li>Report a Bug</li>
                    <hr>
                    <li onclick="checkForUpdates()" id="checkForUpdates">Check For Updates</li>
                    <hr>
                    <li onclick="reloadNoteFinity()">Reload</li>
                    <li onclick="resetNoteFinity()">Reset</li>
                </ul>
            </button>
        </ul>
    </header>
    <div id="editorList">
        <!-- <div class="editor absolute w-full top-14 bottom-7 left-0 right-0 outline-0"></div> -->
    </div>
    <div class="w-full h-7 flex items-start justify-start fixed bottom-0 px-1 overflow-hidden whitespace-nowrap overflow-x-auto tabscroll" id="tabscroll">
        <!-- <div class="tabitem tabitem-active">Untitled <span class="tabitem-close">&times;</span></div> -->
    </div>

    <ul class="absolute w-32 select-none overflow-auto rounded-md shadow-lg hidden navlist-sublist transition-none contextMenu" id="contextMenu">
        <li onclick="editTab.undo()">Undo</li>
        <li onclick="editTab.redo()">Redo</li>
        <hr>
        <li onclick="editTab.cut()">Cut</li>
        <li onclick="editTab.copy()">Copy</li>
        <li onclick="editTab.paste()">Paste</li>
        <li onclick="editTab.delete()">Delete</li>
        <hr>
        <li onclick="editTab.selectAll()">Select All</li>
        <hr>
        <li onclick="convertCaseTo(true)">Convert Case to</li>
        <hr>
        <li onclick="editTab.webSearch()">Web Search</li>
        <li onclick="editTab.openURL()">Open URL</li>
      </ul>


    <script src="../../assets/js/idb.min.js"></script>
    <script src="../../assets/js/ace.js"></script>
    <script src="../../assets/js/compulsory.js"></script>
    <script src="../../assets/js/framecomponents.js"></script>
    <script src="../../assets/js/themes.js"></script>
    <script src="../../assets/js/htmlrootclasses.js"></script>
    <script src="../../assets/js/extensions.js"></script>
    <script src="../../assets/js/convertcase.js"></script>
    <script>
    
        const fdb = new IndexedDBDatabase("filestore");
        const objectStore = "filestore";
        fdb.objectStore = objectStore;
        fdb.createObjectStore(objectStore, "sno", true, {
            filepath: "Untitled",
            changed: false,
            contents: null,
            mode: "text",
            modeChanged: false,
        }, null).then(response=>{
            fdb.delete(1);
        });

        let recentFiles = localStorage.getItem("recentFiles");
        if (recentFiles == null) {
            recentFiles = []
        }
        else {
            recentFiles = JSON.parse(recentFiles);
        }

        const tabscroll = document.getElementById("tabscroll");

        tabscroll.addEventListener("wheel", (e)=>{
            if (e.deltaY > 0) {
                tabscroll.scrollLeft += 40;
            }
            else {
                tabscroll.scrollLeft -= 40;
            }
        })


        class Editor {
            constructor() {
                this.updateEditorElements();
                this.aceEditors = [];
                this.activatedEditor = 0;
                this.wordWrap = false;
                this.autoSave = false;
                this.untitledCount = 0;
                this.readOnly = false;
                this.recentFiles = [];        
            }
            initiate() {
                this.aceEditors = [];
                this.editorElements.forEach(element=>{
                    let editor = ace.edit(element, {
                        theme: "ace/theme/chrome",
                        fontSize: "16px",
                        showPrintMargin: false,
                    });
                    this.aceEditors.push(editor);
                    editor.session.setUseWrapMode(this.wordWrap);
                    editor.commands.bindKey("F1", null);
                    setTimeout(() => {
                        editor.addEventListener("input", ()=>{
                            fileChangeReflected(this.activatedEditor);
                        })
                    }, 200);
                });
            }
            updateEditorElements() {
                this.editorElements = document.querySelectorAll(".editor");
                this.initiate();
            }

            add(text="", filepath=null, mode="text") {
                let div = document.createElement("div");
                div.setAttribute("class", "editor absolute w-full top-14 bottom-7 left-0 right-0 outline-0");
                div.setAttribute("data-filepath", filepath);
                div.setAttribute("data-changed", false);
                div.setAttribute("data-mode", mode);

                _id("editorList").appendChild(div);
                this.updateEditorElements();

                let filename = "Untitled";
                if (filepath == null) {
                    filename = "Untitled";
                    this.untitledCount++;
                    div.setAttribute("data-filepath", `${filename}-${this.untitledCount}`);
                } else {
                    filename = filenameOf(filepath);
                }

                let tabitem = document.createElement("div");
                tabitem.setAttribute("class", "tabitem");
                // tabitem.setAttribute("draggable", true);
                if (filepath == null) {
                    tabitem.innerHTML = `<span class="tabitem-star hidden">*</span> <span class="tabitem-filename">${filename}-${this.untitledCount}</span> <span onclick="tabitemClose(${this.editorElements.length-1})" class="tabitem-close">&times;</span></div>`;
                }
                else {
                    tabitem.innerHTML = `<span class="tabitem-star hidden">*</span> <span class="tabitem-filename">${filename}</span> <span onclick="tabitemClose(${this.editorElements.length-1})" class="tabitem-close">&times;</span></div>`;
                }

                let tabitemListen = document.querySelectorAll(".tabitem").length;
                
                tabitem.onclick = (event) => {
                    if (event.target.getAttribute("class") != "tabitem-close") {
                        this.activateTab(tabitemListen);
                    }
                }

                _id("tabscroll").appendChild(tabitem);
                tabitem.click();
                refreshTextboxTheme();
                refreshFont();
                this.aceEditors[this.aceEditors.length-1].insert(text);
                this.aceEditors[this.aceEditors.length-1].session.setMode(`ace/mode/${mode}`);
                this.aceEditors[this.aceEditors.length-1].resize();
                this.aceEditors[this.aceEditors.length-1].getSession().getUndoManager().reset();
                this.aceEditors[this.aceEditors.length-1].focus(); // Upgradable --> First er dike focus hobe..
            }

            updateEditor(index) {
                let mode = this.editorElements[index].getAttribute("data-mode");
                this.aceEditors[index].session.setMode(`ace/mode/${mode}`);

                let filename = filenameOf(this.editorElements[index].getAttribute("data-filepath"));
                _cls("tabitem-filename")[index].innerHTML = filename;
            }
            
            activateTab(index) {
                this.activatedEditor = index;
                this.editorElements.forEach(element=>{
                    element.style.display = "none";
                })

                this.editorElements[index].style.display = "block";
                notefinity.aceEditors[index].resize();
                
                document.querySelectorAll(".tabitem").forEach(element=>{
                    element.classList.remove("tabitem-active");
                })
                document.querySelectorAll(".tabitem")[index].classList.add("tabitem-active");
                refreshTheme();
                this.aceEditors[index].focus();
                document.querySelectorAll(".tabitem")[index].focus();

                try {
                    let star = "";
                    if (_cls("tabitem-filename")[index].parentElement.getElementsByClassName("tabitem-star")[0].className.indexOf("hidden") == -1) {
                        star = "*";
                    }
                    _id("fileNoteFinityStatus").innerHTML = star + _cls("tabitem-filename")[index].innerHTML;
                }
                catch(err) {}

                if (notefinity.autoSave) {
                    saver.saveAll();
                }

            }
            checkExistance(editor) {
                let existance = this.aceEditors.indexOf(editor);
                if (existance < 0) {
                    return false;
                }
                else {
                    return true;
                }
            }

        }

        const notefinity = new Editor();

        let openedFilesToCheckExistence = [];
        fdb.readAll().then(result=>{
            let i = 0;
            let untitledFilePaths = [];
            result.forEach(data=>{
                if (data.filepath.toLowerCase() == "untitled") {
                    return;
                }
                notefinity.add(data.contents, data.filepath, data.mode);
                if (data.changed == true || data.changed == "true") {
                    fileChangeReflected(i);
                }
                if (data.filepath.toLowerCase().startsWith("untitled-")) {
                    try {
                        let untitledFilePathCount = parseInt(data.filepath.toLowerCase().substr(9));
                        untitledFilePaths.push(untitledFilePathCount);
                    }
                    catch(err) {}
                }
                else {
                    openedFilesToCheckExistence.push(data.filepath);
                }
                notefinity.editorElements[i].setAttribute("data-mode-changed", data.modeChanged);
                i++;
            });

            if (untitledFilePaths.length > 0) {
                untitledFilePaths.sort();
                let lastUntitledFileCount = untitledFilePaths[untitledFilePaths.length-1];
                notefinity.untitledCount += lastUntitledFileCount;
            }

            

            if (document.querySelectorAll(".tabitem").length <= 0 || result.length == 0) {
                notefinity.add();
            }
        }).then(()=>{
            setTimeout(() => {
                ipcRenderer.send("check-file-existence", openedFilesToCheckExistence);
            }, 1200);
        })


        const { ipcRenderer } = require("electron");
        const progressView = new ProgressView();




        function backUpProcess() {
            fdb.deleteAllData().then(response=>{
                for (let i=0; i<notefinity.editorElements.length; i++) {
                    let insertableData = {
                        filepath: notefinity.editorElements[i].getAttribute("data-filepath"),
                        changed: notefinity.editorElements[i].getAttribute("data-changed"),
                        contents: notefinity.aceEditors[i].getValue(),
                        mode: notefinity.editorElements[i].getAttribute("data-mode"),
                        modeChanged: notefinity.editorElements[i].getAttribute("data-mode-changed")
                    }
                    fdb.insertData(insertableData);
                }
            })
        }

        setInterval(() => {
            backUpProcess();
        }, 10000);

        function appAction(action) {
            if (action == "exit") {
                fdb.deleteAllData().then(response=>{
                    for (let i=0; i<notefinity.editorElements.length; i++) {
                        
                        let insertableData = {
                            filepath: notefinity.editorElements[i].getAttribute("data-filepath"),
                            changed: notefinity.editorElements[i].getAttribute("data-changed"),
                            contents: notefinity.aceEditors[i].getValue(),
                            mode: notefinity.editorElements[i].getAttribute("data-mode"),
                            modeChanged: notefinity.editorElements[i].getAttribute("data-mode-changed")
                        }
                        if (insertableData.filepath.toLowerCase().startsWith("untitled-") && insertableData.contents == "") {
                        }
                        else {
                            fdb.insertData(insertableData);
                        }
                    }
                }).then(result=>{
                    progressView.modal("Quiting...");
                    setTimeout(() => {
                        ipcRenderer.send("appAction", action);
                    }, 800);
                    
                })
            }
            else {
                ipcRenderer.send("appAction", action);
            }
        }

        document.addEventListener("keydown", function(event) {
            if (event.ctrlKey && event.key === "r") {
                event.preventDefault();
                reloadFileContents();
            }
            if (event.ctrlKey && event.key == "s") {
                event.preventDefault();
                fileAction("savefile")
            }
            if (event.ctrlKey && event.shiftKey && event.key === "s") {
                event.preventDefault();
            }
            if (event.ctrlKey && event.key == "o") {
                event.preventDefault();
                fileAction("openfile");
            }
            if (event.ctrlKey && event.key == "n") {
                tabNewFile();
            }
            if (event.ctrlKey && event.key == "w") {
                event.preventDefault();
                tabitemClose(notefinity.activatedEditor);
            }
            if (event.ctrlKey && event.key == "Tab") {
                tablist.list();
                if (tablist.htmlElement == null) {
                    tablist.open(notefinity.activatedEditor);
                }
                else {
                    tablist.change();
                }
            }
            if (event.altKey && event.key == "F4") {
                event.preventDefault();
                appAction("exit");
            }
            if (event.keyCode == 116) {
                event.preventDefault();
                insertDate();
            }
            if (event.ctrlKey && event.shiftKey && event.key == "R") {
                event.preventDefault();
                reloadNoteFinity();
            }
            if (event.ctrlKey && event.shiftKey && event.key == "T") {
                event.preventDefault();
                openLastRecentFile();
            }
            if (event.ctrlKey && event.shiftKey && event.key == "S") {
                event.preventDefault();
                fileAction('saveas');
            }
            if (event.ctrlKey && event.altKey && event.key == "p") {
                event.preventDefault();
                openCommandPalette();
            }
        });

        document.addEventListener("keyup", (event)=>{
            if (event.key == "Control") {
                tablist.close();
            }
            if (event.keyCode == 38) {
                if (tablist.htmlElement != null) {
                    tablist.change(0);
                }
            }
            if (event.keyCode == 40) {
                if (tablist.htmlElement != null) {
                    tablist.change(1);
                }
            }
            if (event.keyCode == 27) {
                _id("contextMenu").style.display = "none";
                notefinity.aceEditors[notefinity.activatedEditor].focus();
            }
            if (event.ctrlKey && event.key == "F2") {
                event.preventDefault();
                renameFile();
            }
        });

        document.addEventListener("wheel", (event)=>{
            if (event.ctrlKey) {
                if (event.deltaY > 0) {
                    changeFontSize(0);
                }
                else {
                    changeFontSize(1);
                }
            }
        })

        function openModal(modal) {
            if (modal == "chooselanguage") {
                let defaultValue = true;
                if (notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-mode-changed") == "true" || notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-mode-changed") == true) {
                    defaultValue = false;
                }
                let data = {
                    mode: notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-mode"),
                    defaultValue: defaultValue
                }
                ipcRenderer.send("open-mode-modal", data);
            }
            else if (modal == "minifier") {
                let index = notefinity.activatedEditor;
                let sourceCode = notefinity.aceEditors[index].getValue();
                let mode = notefinity.editorElements[index].getAttribute("data-mode");
                if (!["css", "javascript"].includes(mode)) {
                    mode = "html";
                }
                let data = {
                    code: sourceCode,
                    mode: mode
                }
                localStorage.setItem("temp-data", JSON.stringify(data));
                ipcRenderer.send("open-modal", modal);
            }
            else if (modal == "texttospeech") {
                editTab.selectEditor();
                let text = editTab.getSelection().text;
                if (text == "") {
                    text = notefinity.aceEditors[notefinity.activatedEditor].getValue();
                }
                localStorage.setItem("temp-data", text.toString());
                ipcRenderer.send("open-modal", modal);
            }
            else {
                ipcRenderer.send("open-modal", modal);
            }
        }

        function filenameOf(filepath) {
            let parts = filepath.split("/");
            if (filepath.indexOf("\\") != -1) {
                parts = filepath.split("\\");
            }
            else {
                parts = filepath.split("/");
            }
            return parts[parts.length-1];
        }

        function directoryNameOf(filepath) {
            if (filepath.toLowerCase().startsWith("untitled-")) {
                return " ";
            }
            let lastSlashIndex = filepath.lastIndexOf('\\');
            let directoryPath = filepath.substring(0, lastSlashIndex + 1);
            return directoryPath.substr(0, directoryPath.length-1);
        }



        function checkCustomizationFrame() {
            let customizationFrameData = localStorage.getItem("customizationNavigation");

            if (customizationFrameData != null) {
                customizationFrameData = JSON.parse(customizationFrameData);
                getHeader(customizationFrameData.alignment, customizationFrameData.navigationPane);

                if (customizationFrameData.navigationPane == 3) {
                    _cls("panel-round-exit")[0].style.background = customizationFrameData.colors.close;
                    _cls("panel-round-minimize")[0].style.background = customizationFrameData.colors.minimize;
                    _cls("panel-round-maximize")[0].style.background = customizationFrameData.colors.maximize;
                }
            }
            else {
                getHeader("nba", 3);
            }
            try {
                notefinity.activateTab(notefinity.activatedEditor);
            }
            catch(err) {}
        }
        ipcRenderer.on("check-customization-frame-check", (event, data)=>{
            checkCustomizationFrame();
        })
        
        checkCustomizationFrame();

        function refreshTheme() {
            let themeData = localStorage.getItem("activeTheme");
            if (themeData != null) {
                themeData = JSON.parse(themeData);
            }
            else {
                themeData = themes["Icy Blue"];
            }
            document.body.className = rootClasses.body + " " + themeData.playground;
            _id("tabscroll").className = rootClasses["#tabscroll"] + " " + themeData.playground;
            try {
                document.getElementsByClassName("tabitem-active")[0].className = rootClasses[".tabitem-active"] + " " + themeData.tabactive;
            }
            catch(err) {

            }
            _elms(".navlist-sublist li").forEach(element => {
                element.className = rootClasses[".navlist-sublist li"] + " " + themeData.navigationList;
            });
            _cls("navlist-item").forEach(element => {
                element.className = rootClasses[".navlist-item"] + " " + themeData.navigation;
            });
            _elms("hr").forEach(element=>{
                element.className = themeData.line;
            })
        }
        
        ipcRenderer.on("check-theme-check", (event, data)=>{
            refreshTheme();
        })
        refreshTheme();

        function refreshTextboxTheme() {
            let textboxThemeData = localStorage.getItem("activeTextBoxTheme");
            let textBoxThemeID = "chrome";
            let textBoxThemeImage = false;
            let textBoxGrid = true;
            if (textboxThemeData != null) {
                textboxThemeData = JSON.parse(textboxThemeData);
                textBoxThemeID = textboxThemeData.theme;
                if (textBoxThemeID == "chrome") {
                    textBoxThemeImage = textboxThemeData.image;
                    textBoxGrid = textboxThemeData.grid;
                }
            }
            else {
                textBoxThemeID = "chrome";
                textBoxThemeImage = "../../assets/images/background-gradient.png";
                textBoxGrid = true;
            }

            notefinity.aceEditors.forEach(editor=>{
                editor.setTheme(`ace/theme/${textBoxThemeID}`);
            })

            if (textBoxThemeImage != false) {
                textBoxThemeImage = replaceAll(textBoxThemeImage, "\\\\", "/");
                if (textBoxGrid) {
                    _id("configurableStyle").innerHTML = `.editor {
                        background: url(../../assets/images/background-grid.png), url(${textBoxThemeImage});
                        background-position: center, center;
                        background-size: contain, cover;
                    } `;
                }
                else {
                    _id("configurableStyle").innerHTML = `.editor {
                        background: url(${textBoxThemeImage});
                        background-position: center;
                        background-size: cover;
                    } `;
                }
            }
            else {
                _id("configurableStyle").innerHTML = "";
            }
        }

        ipcRenderer.on("check-textbox-theme-check", (event, data)=>{
            refreshTextboxTheme();

        })
        refreshTextboxTheme();

        function tabNewFile() {
            notefinity.add();
        }

        function pushInRecentFiles(index) {
            if (!notefinity.editorElements[index].getAttribute("data-filepath").toLowerCase().startsWith("untitled-")) {
                recentFiles.push(notefinity.editorElements[index].getAttribute("data-filepath"));
                notefinity.recentFiles.push(notefinity.editorElements[index].getAttribute("data-filepath"));
                recentFiles = [... new Set(recentFiles)];
                let recentFilesLimit = 100;
                if (recentFiles.length > recentFilesLimit) {
                    let removeCount = recentFiles.length - recentFilesLimit;
                    recentFiles.splice(0, removeCount);
                }
                localStorage.setItem("recentFiles", JSON.stringify(recentFiles));
            }
        }

        function tabitemClose(index) {
            if (notefinity.editorElements.length == 1) {
                if (_cls("tabitem-star")[0].className.indexOf("hidden") == -1) {
                    confirmModal("Close without saving? Unsaved data will be lost.").then(response=>{
                        if (response) {
                            pushInRecentFiles(index);
                            let noteElement = notefinity.editorElements[index];
                            notefinity.aceEditors[index].destroy();
                            noteElement.remove();
                            notefinity.updateEditorElements();
                            appAction("exit");
                        }
                    })
                }
                else {
                    pushInRecentFiles(index);
                    let noteElement = notefinity.editorElements[index];
                    notefinity.aceEditors[index].destroy();
                    noteElement.remove();
                    notefinity.updateEditorElements();
                    appAction("exit");
                }
            }
            else {
            if (_cls("tabitem-star")[index].className.indexOf("hidden") == -1) {
                confirmModal("Close without saving? Unsaved data will be lost.").then(response=>{
                    if (response) {
                        pushInRecentFiles(index);
                        let noteElement = notefinity.editorElements[index];
                        notefinity.aceEditors[index].destroy();
                        noteElement.remove();

                        document.querySelectorAll(".tabitem")[index].remove();
                        let tabitemCloseIcons = document.querySelectorAll(".tabitem-close");
                        
                        for (let i=0; i<tabitemCloseIcons.length; i++) {
                            tabitemCloseIcons[i].setAttribute("onclick", `tabitemClose(${i}, this)`);
                        }
                        
                        let tabitems = document.querySelectorAll(".tabitem");
                        for (let j=0; j<tabitems.length; j++) {
                            tabitems[j].onclick = (event) => {
                                if (event.target.getAttribute("class") != "tabitem-close") {
                                    notefinity.activateTab(j);
                                }
                            }
                        }
                        notefinity.updateEditorElements();
                        try {
                            tabitems[index-1].click();
                        }
                        catch(err) {
                            try {
                                tabitems[tabitems.length-1].click();
                            }
                            catch(err) {}
                        }
                    }
                    else {
                        return;
                    }
                })
            }
            else {
                pushInRecentFiles(index);
                let noteElement = notefinity.editorElements[index];
                notefinity.aceEditors[index].destroy();
                noteElement.remove();
                notefinity.updateEditorElements();

                document.querySelectorAll(".tabitem")[index].remove();
                let tabitemCloseIcons = document.querySelectorAll(".tabitem-close");
                
                for (let i=0; i<tabitemCloseIcons.length; i++) {
                    tabitemCloseIcons[i].setAttribute("onclick", `tabitemClose(${i}, this)`);
                }
                
                let tabitems = document.querySelectorAll(".tabitem");
                for (let j=0; j<tabitems.length; j++) {
                    tabitems[j].onclick = (event) => {
                        if (event.target.getAttribute("class") != "tabitem-close") {
                            notefinity.activateTab(j);
                        }
                    }
                }
                notefinity.updateEditorElements();
                try {
                    tabitems[index-1].click();
                }
                catch(err) {
                    try {
                        tabitems[tabitems.length-1].click();
                    }
                    catch(err) {}
                }
            }
        }
        }

        class FileSaver {
            constructor() {
            }
            save(saveAs=false) {
                let noteFinityIndex = notefinity.activatedEditor;
                let filepath = notefinity.editorElements[noteFinityIndex].getAttribute("data-filepath");
                let contents = notefinity.aceEditors[noteFinityIndex].getValue();
                if (filepath.toLowerCase().startsWith("untitled-") || saveAs == true) {
                    ipcRenderer.send("fileAction", {
                        action: "savefile",
                        type: "untitled",
                        contents: contents,
                        index: noteFinityIndex
                    })
                }
                else {   
                    ipcRenderer.send("fileAction", {
                        action: "savefile",
                        type: "manual",
                        filepath: filepath,
                        contents: contents,
                        index: noteFinityIndex
                    })
                }   
            }
            saveAs() {
                this.save(true);
            }
            saveCopy() {
                let noteFinityIndex = notefinity.activatedEditor;
                let filepath = notefinity.editorElements[noteFinityIndex].getAttribute("data-filepath");
                let contents = notefinity.aceEditors[noteFinityIndex].getValue();
                ipcRenderer.send("fileAction", {
                    action: "savecopy",
                    type: "copy",
                    contents: contents,
                    index: noteFinityIndex
                })
            }
            saveAll() {
                let fileData = [];
                for (let i=0; i<notefinity.editorElements.length; i++) {
                    let filepath = notefinity.editorElements[i].getAttribute("data-filepath");
                    if (!filepath.toLowerCase().startsWith("untitled-")) {
                        let data = {
                            filepath: notefinity.editorElements[i].getAttribute("data-filepath"),
                            contents: notefinity.aceEditors[i].getValue(),
                        }
                        fileData.push(data);
                    }
                    else {
                    }
                }
                ipcRenderer.send("fileAction", {
                    action: "savemany",
                    type: "many",
                    data: fileData
                });
            }
        }

        ipcRenderer.on("saveAlert", (event, data)=>{
            // if (data.success == false) {
            //     alertModal("Unable to save the file at this location. Please select a different name or directory.", "error");
            //     return;
            // }
            if (data.action == "untitledsave") {
                if (data.success == "true" || data.success == true) {
                    notefinity.editorElements[data.index].setAttribute("data-filepath", data.filepath);
                    
                    if (notefinity.editorElements[data.index].getAttribute("data-mode-changed") == "true" || notefinity.editorElements[data.index].getAttribute("data-mode-changed") == true) {
                        notefinity.updateEditor(data.index);
                        fileSaveReflected(data.index);
                    }
                    else {
                        try {
                            notefinity.editorElements[data.index].setAttribute("data-mode", extensionModes[extensionOf(data.filepath)]);
                        } catch(err) {}
                        notefinity.updateEditor(data.index);
                        fileSaveReflected(data.index);
                    }
                }
                else {
                    alertModal("Unable to save the file at this location. Please select a different name or directory.", "error");
                    return;
                }
            }
            else if (data.action == "manualsave") {
                if (data.success == true || data.success == "true") {
                    fileSaveReflected(data.index);
                }
                else {
                    alertModal("Unable to save the file at this location. Please select a different name or directory.", "error");
                    return;
                }
            }
            else if (data.action == "savemany") {
                for (let i=0; i<notefinity.editorElements.length; i++) {
                    let element = notefinity.editorElements[i];
                    if (data.saveDone.indexOf(element.getAttribute("data-filepath")) != -1) {
                        fileSaveReflectedOnTab(i);
                    }
                }
                fileSaveReflected(notefinity.activatedEditor);
                notefinity.aceEditors[notefinity.activatedEditor].focus();

                if (data.saveFailed.length == 0) {
                    return;
                }
                else {
                    let result;
                    if (data.saveFailed.length == 1) {
                        result = data.saveFailed[0].toString();
                    }
                    else {
                        let lastElement = data.saveFailed.pop();
                        result = data.saveFailed.join(", ") + " and " + lastElement;
                    }
                    alertModal(`Unable to save ${result}`, "error");
                }
                
            }
        })

        const saver = new FileSaver();

        function fileAction(action) {
            if (action == "openfile") {
                ipcRenderer.send("fileAction", "openfile");
            }
            else if (action == "savefile") {
                saver.save();
            }
            else if (action == "saveas") {
                saver.saveAs();
            }
            else if (action == "savecopyas") {
                saver.saveCopy();
            }
            else if (action == "saveall") {
                saver.saveAll();
            }
        }

        ipcRenderer.on("back-openFile", (event, data)=>{
            ipcRenderer.send("getFileContents", data);
        })

        ipcRenderer.on("back-getFileContents", (event, data)=>{
            if (data.contents == null) {
                alertModal("File cannot be opened. Please check if it exists.", "error");
                return;
            }
            for (let i = 0; i<notefinity.editorElements.length; i++) {
                if (notefinity.editorElements[i].getAttribute("data-filepath") == data.filepath) {
                    notefinity.activateTab(i);
                    return;
                }
            }

            let languageMode = "text";
            try {
                languageMode = extensionModes[extensionOf(data.filepath)];
            }
            catch(err) {
                if (err) {
                    languageMode = "text";
                }
            }
            notefinity.add(data.contents, data.filepath, languageMode);
        }) 

        // function toggleWordWrap(elm) {
        //     if (notefinity.wordWrap) {
        //         notefinity.wordWrap = false;
        //         elm.getElementsByTagName("input")[0].checked = false;
        //     }
        //     else {
        //         elm.getElementsByTagName("input")[0].checked = true;
        //         notefinity.wordWrap = true;
        //     }
        //     notefinity.updateEditorElements();
        // }
        
        function fileChangeReflected(index) {
            _cls("tabitem-star")[index].classList.remove("hidden");
            try {
                _id("fileNoteFinityStatus").innerHTML = "*" + _cls("tabitem-filename")[index].innerHTML;
                notefinity.editorElements[index].setAttribute("data-changed", true);
            }
            catch(err) {}
        }

        function fileSaveReflected(index) {
            _cls("tabitem-star")[index].classList.add("hidden");
            try {
                _id("fileNoteFinityStatus").innerHTML = _cls("tabitem-filename")[index].innerHTML;
                notefinity.editorElements[index].setAttribute("data-changed", false);
            }
            catch(err) {}
        }
        function fileSaveReflectedOnTab(index) {
            _cls("tabitem-star")[index].classList.add("hidden");
            try {
                notefinity.editorElements[index].setAttribute("data-changed", false);
            }
            catch(err) {}
        }

        // Reload a file
        function reloadFileContents() {
            let index = notefinity.activatedEditor;
            if (!notefinity.editorElements[index].getAttribute("data-filepath").toLowerCase().startsWith("untitled-")) {
                let filepath = notefinity.editorElements[index].getAttribute("data-filepath");
                let data = {
                    filepath: filepath,
                    index: index
                }
                if (notefinity.editorElements[index].getAttribute("data-changed") == "true") {
                    confirmModal("Reload the file? Unsaved data will be lost.").then(response=>{
                        if (response) {
                            ipcRenderer.send("reloadFileContents", data);
                        }
                    })
                }
                else {
                    ipcRenderer.send("reloadFileContents", data);
                }
            }
        }
        ipcRenderer.on("back-reloadFileContents", (event, data)=>{
            if (data.contents == null) {
                alertModal("File cannot be reloaded. Please check if it exists.", "error");
                return;
            }
            notefinity.aceEditors[data.index].setValue("");
            notefinity.aceEditors[data.index].insert(data.contents);
            setTimeout(() => {
                fileSaveReflected(data.index);
            }, 200);
        })

        // Language changing
        ipcRenderer.on("back-changed-language-mode", (event, data)=>{
            if (data == "") {

                let filepath = notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-filepath");

                let languageMode = extensionModes[extensionOf(notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-filepath"))];

                if (filepath.toLowerCase().startsWith("untitled-")) {
                    languageMode = "text";
                }

                notefinity.editorElements[notefinity.activatedEditor].setAttribute("data-mode", languageMode);
                notefinity.editorElements[notefinity.activatedEditor].setAttribute("data-mode-changed", false);
            }
            else {
                notefinity.editorElements[notefinity.activatedEditor].setAttribute("data-mode", data);
                notefinity.editorElements[notefinity.activatedEditor].setAttribute("data-mode-changed", true);
            }
            notefinity.updateEditor(notefinity.activatedEditor);
        })

        class EditTab {
            constructor() {
                
            }
            selectEditor() {
                this.editor = notefinity.aceEditors[notefinity.activatedEditor];
            }
            getSelection() {
                this.selection = {
                    range: this.editor.getSelectionRange(),
                    text: this.editor.getSelectedText(),
                }
                return this.selection;
            }
            checkTextSelection(text) {
                if (text == "" || text == null) {
                    alertModal("No text selected");
                    return false;
                }
                else {
                    return true;
                }
            }
            removeUnnecessarySpaces() {
                this.selectEditor();
                let selection = this.getSelection();
                if (this.checkTextSelection(selection.text)) {
                    let replaceText = selection.text.replace(/\s+/g, " ").trim();
                    this.editor.session.replace(selection.range, replaceText);
                }
            }
            deleteEmptyLines() {
                this.selectEditor();
                let contents = this.editor.getValue();
                let nonEmptyValue = contents.replace(/^\s*[\r\n]/gm, "");
                this.editor.setValue(nonEmptyValue);
                this.focus();
            }
            sanitizeHTML() {
                this.selectEditor();
                let selection = this.getSelection();
                let text = selection.text;
                if (selection.text == "" || selection.text == null) {
                    text = this.editor.getValue();
                }
                text = replaceAll(text, "<", "&lt;");
                text = replaceAll(text, ">", "&gt;");
                text = replaceAll(text, "\\\\", "&bsol;");
                
                if (selection.text == "" || selection.text == null) {
                    this.editor.setValue("");
                    this.editor.insert(text);
                }
                else {
                    this.editor.session.replace(selection.range, text);
                }
                this.focus();
                
            }
            convertCaseTo(caseName) {
                this.selectEditor();
                let selection = this.getSelection();
                if (this.checkTextSelection(selection.text)) {
                    let replaceText = selection.text;
                    switch (caseName) {
                        case "uppercase":
                            replaceText = selection.text.toUpperCase();
                            break;
                        case "lowercase":
                            replaceText = selection.text.toLowerCase();
                            break;
                        case "randomcase":
                            replaceText = convertToRandomCase(selection.text);
                            break;
                        case "invertcase":
                            replaceText = convertToInvertCase(selection.text);
                            break;
                        case "propercase":
                            replaceText = convertToProperCase(selection.text);
                            break;
                        case "sentencecase":
                            replaceText = convertToSentenceCase(selection.text);
                            break;

                        default:
                            replaceText = selection.text;
                    }
                    this.editor.session.replace(selection.range, replaceText);
                }
            }
            insertDate() {
                this.selectEditor();
                const date = new Date();
                let hours = date.getHours();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                if (hours < 10) {
                    hours = "0" + hours.toString();
                }
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const currentDate = date.toLocaleDateString('en-US', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const time = hours + ':' + minutes + ' ' + ampm + ' ' + currentDate;
                this.editor.insert(time);
                this.editor.focus();
            }
            openFindPanel() {
                this.selectEditor();
                this.editor.execCommand("find");
            }
            openFindReplacePanel() {
                this.selectEditor();
                this.editor.execCommand("replace");
            }
            selectAll() {
                this.selectEditor();
                this.editor.selectAll();
                this.focus();
            }
            checkReadOnly() {
                if (notefinity.readOnly) {
                    alertModal("To allow modifications, please disable read-only mode.", "error");
                    return true;
                }
                else {
                    return false;
                }
            }
            focus() {
                try {
                    this.selectEditor();
                    this.editor.focus();
                }
                catch(err) {}
            }
            undo() {
                if (this.checkReadOnly()) {
                    return;
                }
                notefinity.aceEditors[notefinity.activatedEditor].undo();
                this.focus();
            }
            redo() {
                if (this.checkReadOnly()) {
                    return;
                }
                notefinity.aceEditors[notefinity.activatedEditor].redo();
                this.focus();
            }
            cut() {
                this.selectEditor();
                if (this.checkReadOnly()) {
                    return;
                }
                document.execCommand("copy");
                this.editor.session.remove(this.getSelection().range);
                this.focus();
            }
            copy() {
                document.execCommand("copy");
                this.focus();
            }
            delete() {
                if (this.checkReadOnly()) {
                    return;
                }
                this.selectEditor();
                this.editor.session.remove(this.getSelection().range);
                this.focus();
            }
            paste() {
                if (this.checkReadOnly()) {
                    return;
                }
                this.selectEditor();
                document.execCommand("paste");
                this.focus();
            }
            webSearch() {
                this.selectEditor();
                let text = this.getSelection().text;
                if (text == "") {
                    alertModal("No text selected");
                }
                else {
                    localStorage.setItem("temp-data", text.toString());
                    openModal("web-search");
                }
            }
            openURL() {
                this.selectEditor();
                let text = this.getSelection().text;
                if (text == "") {
                    alertModal("No text selected");
                }
                else {
                    ipcRenderer.send("open-in-application", text);
                }
            }
        }

        const editTab = new EditTab();
        function removeUnnecessarySpaces() {
            if (notefinity.readOnly) {
                alertModal("To allow modifications, please disable read-only mode.", "error");
            }
            else {
                editTab.removeUnnecessarySpaces();
            }
        }
        function deleteEmptyLines() {
            if (notefinity.readOnly) {
                alertModal("To allow modifications, please disable read-only mode.", "error");
            }
            else {
                editTab.deleteEmptyLines();
            }
        }

        function sanitizeHTML() {
            if (notefinity.readOnly) {
                alertModal("To allow modifications, please disable read-only mode.", "error");
            }
            else {
                editTab.sanitizeHTML();
            }
        }

        class Tablist {
            constructor() {
                this.htmlElement = null;
                this.fileList = [];
                this.current = 0;
            }
            list() {
                this.fileList = [];
                notefinity.editorElements.forEach(element=>{
                    this.fileList.push(filenameOf(element.getAttribute("data-filepath")));
                });
            }
            open(focus=0) {
            if (this.htmlElement != null) {
                return;
            }
            this.htmlElement = document.createElement("div");
            this.htmlElement.setAttribute("id", "tabList");
            this.htmlElement.setAttribute("class", "fixed flex bg-[#00000092] w-full h-full inset-0 z-[1000] justify-center items-center");

            let buttonHTML = "";
            this.fileList.forEach(element=>{
                buttonHTML += `<button class="p-1 outline-0 border-t border-b border-transparent">${element}</button>`;
            })

            this.htmlElement.innerHTML = `<div class="text-white max-w-[90vw] max-h-[50vh] overflow-auto flex flex-col text-center">
                    ${buttonHTML}
                </div>`;
            document.body.appendChild(this.htmlElement);
            this.focusOn(focus);
            this.current = focus;
            }
            close() {
                if (this.htmlElement != null) {
                    document.body.removeChild(this.htmlElement);
                    this.htmlElement = null;
                    notefinity.activateTab(this.current);
                }
            }
            focusOn(index) {
                let buttonElements = this.htmlElement.childNodes[0].querySelectorAll("button");
                buttonElements.forEach(element=>{
                    element.classList.remove("border-white");
                    element.classList.add("border-transparent");
                })
                buttonElements[index].classList.remove("border-transparent");
                buttonElements[index].classList.add("border-white");
                buttonElements[index].focus();
            }
            change(n=1) {
                let elmList = this.htmlElement.childNodes[0].getElementsByTagName("button");
                if (n == 1) {
                    this.current++;
                }
                else {
                    this.current--;
                }

                if (this.current >= elmList.length) {
                    this.current = 0;
                }
                else if (this.current < 0) {
                    this.current = elmList.length-1;
                }

                this.focusOn(this.current);
            }
        }

        const tablist = new Tablist();

        function openFolder() {
            ipcRenderer.send("openFolder", true);
        }

        let alwaysOnTop = false;
        function viewAlwaysOnTop(element) {
            if (!alwaysOnTop) {
                ipcRenderer.send("always-on-top", true);
                alwaysOnTop = true;
                element.getElementsByTagName("input")[0].checked = true;
            }
            else {
                ipcRenderer.send("always-on-top", false);
                alwaysOnTop = false;
                element.getElementsByTagName("input")[0].checked = false;
            }
        }

        function toggleFullScreenMode() {
            ipcRenderer.send("toggle-full-screen-mode", true);
            notefinity.aceEditors[notefinity.activatedEditor].focus();
        }

        let onceHidden = false;
        function temporarilyHide() {
            if (!onceHidden) {
                alertModal("You can display NoteFinity from the system tray.").then(response=>{
                    notefinity.aceEditors[notefinity.activatedEditor].focus();
                    ipcRenderer.send("temporarily-hide", true);
                    onceHidden = true;
                })
            }
            else {
                notefinity.aceEditors[notefinity.activatedEditor].focus();
                ipcRenderer.send("temporarily-hide", true);
            }
        }
    
        function resetNoteFinity() {
            confirmModal("Do you want to reset NoteFinity? This action will delete all customizations, unsaved changes, and the list of recently opened files.").then(response=>{
                if (response) {
                    ipcRenderer.send("reset-notefinity", true);
                    let request = indexedDB.deleteDatabase("filestore");
                    request.onsuccess = function(event) {
                        localStorage.clear();
                    }
                    request.onerror = function(event) {
                        return;
                    };
                    localStorage.clear();
                    progressView.modal("Resetting...");
                    setTimeout(() => {
                        ipcRenderer.send("appAction", "reload");
                    }, 2600);
                }
            })
        }
        function reloadNoteFinity() {
            backUpProcess();
            progressView.modal("Reloading...");
            setTimeout(() => {
                ipcRenderer.send("appAction", "reload");
            }, 1000);
        }

        function openAboutNoteFinity() {
            ipcRenderer.send("open-in-application", "https://www.bracketcounters.com");
        }

        function renameFile() {
            let index = notefinity.activatedEditor;
            let editor = notefinity.editorElements[index];
            let filepath = editor.getAttribute("data-filepath");
            if (filepath.toLowerCase().startsWith("untitled-")) {
                alertModal("Cannot rename an untitled file. Save the file first.", "error")
                return;
            }
            else {
                let defaultFilePath = editor.getAttribute("data-filepath");
                let defaultFilename = filenameOf(defaultFilePath);
                promptModal(prompt="Enter filename", defaultValue=defaultFilename, type="rename").then(response=>{
                    if (response != false && response != defaultFilename) {
                        progressView.loader();
                        let data = {
                            action: "renameFile",
                            filepath: defaultFilePath,
                            renameTo: response,
                            index: index
                        }
                        ipcRenderer.send("fileAction", data);
                    }
                });
            }
        }

        ipcRenderer.on("rename-response", (event, data)=>{
            progressView.close();
            if (data.success == true) {
                let editor = notefinity.editorElements[data.index];
                editor.setAttribute("data-filepath", data.filepath);
                if (editor.getAttribute("data-mode-changed") == true || editor.getAttribute("data-mode-changed") == "true") {
                }
                else {
                    editor.setAttribute("data-mode", extensionModes[extensionOf(data.filepath)]);   
                }
                notefinity.updateEditor(data.index);
                notefinity.activateTab(notefinity.activatedEditor);
            }
            else {
                if (data.message != undefined) {
                    alertModal(data.message, "error");
                }
                else {
                    alertModal("Unable to rename this file", "error");
                }
            }
        })


        let filedragger = new FileDragger();

        window.addEventListener("dragover", (event)=>{
            event.preventDefault();
            event.dataTransfer.effectAllowed = "copy";
            event.dataTransfer.dropEffect = "copy";
            filedragger.open().then(response=>{
                response.forEach(file=>{
                    ipcRenderer.send("getFileContents", file.path);
                })
            })
        });

        function changeFontSize(scale) {
            let fontData = localStorage.getItem("fontData");
            if (fontData == null) {
                fontData = {
                    size: 16,
                    weight: 4,
                    italic: false,
                }
            }
            else {
                fontData = JSON.parse(fontData);
            }
            let fontSize = fontData.size;
            if (scale == 1) {
                fontSize++;
            }
            else {
                fontSize--;
            }

            if (fontSize < 5) {
                fontSize = 5;
            }
            if (fontSize > 100) {
                fontSize = 100;
            }

            fontData.size = fontSize;

            localStorage.setItem("fontData", JSON.stringify(fontData));
            refreshFont();
        }

        function refreshFont() {
            let fontData = localStorage.getItem("fontData");
            if (fontData == null) {
                fontData = {
                    size: 16,
                    weight: 4,
                    italic: false,
                }
            }
            else {
                fontData = JSON.parse(fontData);
            }
            notefinity.aceEditors.forEach(editor=>{
                editor.setFontSize(`${fontData.size}px`);
            })
            let fontStyleCSS = "";
            if (fontData.italic) {
                fontStyleCSS = "font-style: italic;"
            }
            _id("configurableFont").innerHTML = `.editor {
                font-weight: ${fontData.weight * 100};
                ${fontStyleCSS}
            }`;
        }
        ipcRenderer.on("check-font-data", (event, data)=>{
            refreshFont();
        })
        refreshFont();

        function viewInApplication() {
            let filepath = notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-filepath");
            if (filepath.toLowerCase().startsWith("untitled-")) {
                alertModal("Please save the file before attempting to open it in application.");
            }
            else {
                let filepath = notefinity.editorElements[notefinity.activatedEditor].getAttribute("data-filepath");
                let noOpenExtensions = ["txt", "md", "json", "ini", "conf", "bat", "log", "gitignore", "npmignore", "ps1", "css"];
                if (!noOpenExtensions.includes(extensionOf(filepath))) {
                    ipcRenderer.send("open-in-application", filepath);
                }
            }
        }

        function toggleReadOnly(elm) {
            notefinity.aceEditors.forEach(editor=>{
                editor.setReadOnly(!notefinity.readOnly);
            })
            elm.querySelector("input").checked = !notefinity.readOnly;
            notefinity.readOnly = !notefinity.readOnly;
        }

        function convertCaseTo(single=false) {
            if (notefinity.readOnly) {
                alertModal("To allow modifications, please disable read-only mode.", "error");
                return;
            }
            else {
                if (single) {
                    editTab.selectEditor();
                    if (editTab.getSelection().text == "") {
                        alertModal("No text selected");
                        return;
                    }
                    openModal("convert-case-to-single");
                }
                else {
                    openModal("convert-case-to");
                }
            }
        }

        ipcRenderer.on("back-convert-case", (event, data)=>{
            editTab.convertCaseTo(data);
        })

        function insertDate() {
            if (notefinity.readOnly) {
                alertModal("To allow modifications, please disable read-only mode.", "error");
                return;        
            }
            else {
                editTab.insertDate();
            }
        }

        function openLastRecentFile() {
            let openedFiles = [];
            notefinity.editorElements.forEach(element=>{
                let filepath = element.getAttribute("data-filepath");
                if (!filepath.toLowerCase().startsWith("untitled-")) {
                    openedFiles.push(element.getAttribute("data-filepath"));
                }
            });
            let recentFiles = notefinity.recentFiles.filter((value)=>{
                return !openedFiles.includes(value);
            });

            recentFiles = recentFiles.reverse();
            if (recentFiles.length > 0) {
                ipcRenderer.send("check-recent-file-open", recentFiles[0]);
            }
        }

        ipcRenderer.on("back-check-file-not-exists", (event, data)=>{
            if (data.length == 0) {
                return;
            }
            let result;
            let sLetter = "s";
            if (data.length == 1) {
                result = data[0].toString();
            } else {
                const lastElement = data.pop();
                result = data.join(", ") + " and " + lastElement;
                sLetter = "";
            }

            alertModal(`Please check if ${result} exist${sLetter}.<br><br>However, NoteFinity is displaying previously saved content.`, "error");
        })

        ipcRenderer.on("back-check-recent-fileopen", (event, data)=>{
            if (data.exists) {
                ipcRenderer.send("getFileContents", data.filepath);
            }
            else {
                let index = notefinity.recentFiles.indexOf(data.filepath);
                if (index !== -1) {
                    notefinity.recentFiles.splice(index, 1); // Removes one element at the found index
                }
                openLastRecentFile();
            }
        })

        function fetchFromInternet() {
            promptModal("Enter a valid URL", "", null, "url").then(response=>{
                if (response != false) {
                    progressView.loader();
                    ipcRenderer.send("fetch-from-internet", response);
                }
            })
        }

        ipcRenderer.on("back-fetch-from-internet", (event, data)=>{
            progressView.close();
            if (data.status == false) {
                alertModal("Content fetch error. Check URL and internet connection.", "error");
            }
            else {
                let contentType = "text";
                let openAble = true;
                if (data.contentType != undefined) {
                    if (data.contentType.includes("text/html")) {
                        contentType = "html";
                        openAble = true;
                    }
                    else if (data.contentType.includes("application/javascript")) {
                        contentType = "javascript";
                        openAble = true;
                    }
                    else if (data.contentType.includes("text/javascript")) {
                        contentType = "javascript";
                        openAble = true;
                    }
                    else if (data.contentType.includes("text/css")) {
                        contentType = "css";
                        openAble = true;
                    }
                    else if (data.contentType.includes("application/json")) {
                        contentType = "json";
                        openAble = true;
                    }
                    else if (data.contentType.includes("text/plain")) {
                        contentType = "text";
                        openAble = true;
                    }
                    else if (data.contentType.includes("text/xml")) {
                        contentType = "xml";
                        openAble = true;
                    }
                    else if (data.contentType.includes("image/svg")) {
                        contentType = "svg";
                        openAble = true;
                    }
                    else {
                        openAble = false;
                        contentType = "text";
                    }
                }
                
                if (openAble) {
                    notefinity.add(data.contents, null, contentType);
                    fileChangeReflected(notefinity.activatedEditor);
                    notefinity.editorElements[notefinity.activatedEditor].setAttribute("data-mode-changed", true);
                }
                else {
                    confirmModal(`The file has a content-type of ${data.contentType}. Would you like to proceed with opening it?`).then(response=>{
                        if (response) {
                            notefinity.add(data.contents, null, contentType);
                            fileChangeReflected(notefinity.activatedEditor);
                            notefinity.editorElements[notefinity.activatedEditor].setAttribute("data-mode-changed", true);
                        }
                    })
                }
            }
        })

        // openModal('copytoclipboard');

        function copyToClipboard(text) {
            let textarea = document.createElement("textarea");
            textarea.innerHTML = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            textarea.remove();
        }



        ipcRenderer.on("back-copy-to-clipboard", (event, data)=>{
            let currentEditor = notefinity.editorElements[notefinity.activatedEditor];
            let copyAble;
            switch (data) {
                case "filepath":
                    copyToClipboard(currentEditor.getAttribute("data-filepath"));
                    break;
                case "filename":
                    copyToClipboard(filenameOf(currentEditor.getAttribute("data-filepath")));
                    break;
                case "dirpath":
                    copyToClipboard(directoryNameOf(currentEditor.getAttribute("data-filepath")));
                    break;
                case "allfilepaths":
                    copyAble = "";
                    notefinity.editorElements.forEach(element => {
                        copyAble += element.getAttribute("data-filepath") + "\n";
                    });
                    copyToClipboard(copyAble);
                    break;
                case "allfilenames":
                    copyAble = "";
                        notefinity.editorElements.forEach(element => {
                            copyAble += filenameOf(element.getAttribute("data-filepath")) + "\n";
                        });
                    copyToClipboard(copyAble);
                    break;

                default:
                    break;
            }
        })


        let closeDocumentAlertShow = false;
        function closeAllFiles() {
            for (let i = notefinity.editorElements.length-1; i > 0; i--) {
                let editor = notefinity.editorElements[i];
                if (editor.getAttribute("data-changed") == "false" || editor.getAttribute("data-changed") == false) {              
                    tabitemClose(i);
                }
                else {
                    if (!closeDocumentAlertShow) {
                        alertModal("Please manually close all unsaved files");
                        closeDocumentAlertShow = true;
                    }
                }
            }
            if (notefinity.editorElements.length == 1) {
                tabitemClose(0);
            }
        }

        let closeToTheDirectionAlertShow = false;
        function closeToTheLeft() {
            let preActivaedEditor = notefinity.activatedEditor;
            let closeCount = 0;
            for (let i = preActivaedEditor-1; i >= 0; i--) {
                if (notefinity.editorElements[i].getAttribute("data-changed") == "false" || notefinity.editorElements[i].getAttribute("data-changed") == false) {
                    tabitemClose(i);
                    closeCount++;
                }
                else {
                    if (!closeToTheDirectionAlertShow) {
                        alertModal("Please manually close all unsaved files");
                        closeToTheDirectionAlertShow = true;
                    }
                }
            }
            document.querySelectorAll(".tabitem")[preActivaedEditor-closeCount].click();
        }

        function closeToTheRight() {
            let preActivaedEditor = notefinity.activatedEditor;
            let editorLength = notefinity.editorElements.length;
            for (let i = editorLength-1; i > preActivaedEditor; i--) {
                if (notefinity.editorElements[i].getAttribute("data-changed") == "false" || notefinity.editorElements[i].getAttribute("data-changed") == false) {
                    tabitemClose(i);
                }
                else {
                    if (!closeToTheDirectionAlertShow) {
                        alertModal("Please manually close all unsaved files");
                        closeToTheDirectionAlertShow = true;
                    }
                }
            }
            document.querySelectorAll(".tabitem")[preActivaedEditor].click();
        }
        function closeAllButActiveDocument() {
            closeToTheLeft();
            closeToTheRight();
        }

        ipcRenderer.on("return-code-minifier-action", (event, data)=>{
            let editor = notefinity.aceEditors[notefinity.activatedEditor];
            if (data.action == "replace") {
                editor.setValue("");
                editor.insert(data.code);
            }
            else if (data.action == "newtab") {
                notefinity.add(text=data.code, null, data.mode);
                fileChangeReflected(notefinity.activatedEditor);
            }
        });

        let markdownPreviewerOpened = false;
        let intervalId;
        function previewMarkdown() {
            if (!markdownPreviewerOpened) {
                markdownPreviewerOpened = true;
                let markdownEditor = notefinity.aceEditors[notefinity.activatedEditor];
                let data = {};
                intervalId = setInterval(() => {
                    if (notefinity.checkExistance(markdownEditor)) {
                        let markdown = markdownEditor.getValue();
                        data = {
                            exists: true,
                            markdown: markdown.toString()
                        }
                    }
                    else {
                        data = {
                            exists: false,
                            markdown: null
                        }
                    }
                    localStorage.setItem("markdown-previewer", JSON.stringify(data));
                }, 600);
                ipcRenderer.send("markdown-previewer", true);
            }
            else {
                alertModal("Markdown previewer is already running");
            }
        }

        ipcRenderer.on("markdown-closed", (event, data)=>{
            clearInterval(intervalId);
            localStorage.setItem("markdown-previewer", "");
            markdownPreviewerOpened = false;
        })

        ipcRenderer.on("show-alert", (event, data)=>{
            alertModal(data[0], data[1]);
        })

        let editorConf = localStorage.getItem("editor-conf");
        if (editorConf == null) {
            editorConf = {};
            editorConf.wordWrap = true;
            editorConf.autoSave = false;
        }
        else {
            editorConf = JSON.parse(editorConf);
        }

        if (editorConf.wordWrap == true) {
            _id("navWordWrap").querySelector("input").checked = true;
            notefinity.wordWrap = true;
            notefinity.updateEditorElements();
        }

        if (editorConf.autoSave == true) {
            _id("navAutoSave").querySelector("input").checked = true;
            notefinity.autoSave = true;
        }

        function storeEditorConf() {
            let data = {
                wordWrap: notefinity.wordWrap,
                autoSave: notefinity.autoSave
            }
            localStorage.setItem("editor-conf", JSON.stringify(data));
        }

        _id("navWordWrap").addEventListener("click", ()=>{
            let checked = _id("navWordWrap").querySelector("input").checked;
            _id("navWordWrap").querySelector("input").checked = !checked;
            notefinity.wordWrap = !checked;
            notefinity.updateEditorElements();
            storeEditorConf();
        })

        _id("navAutoSave").addEventListener("click", ()=>{
            let checked = _id("navAutoSave").querySelector("input").checked;
            _id("navAutoSave").querySelector("input").checked = !checked;
            notefinity.autoSave = !checked;
            storeEditorConf();
        })
        


        window.addEventListener("contextmenu", (event)=>{
            event.preventDefault();
            let parentElement = event.target.parentElement.tagName.toLowerCase();
            if (parentElement == "header" || parentElement == "ul" || parentElement == "li" || parentElement == "button") {
                return;
            }
            _id("contextMenu").style.display = "block";
            let left = event.pageX;
            let top = event.pageY;
            if (left + 130 > window.innerWidth) {
                left -= 130;
            }
            if (top + 320 > window.innerHeight) {
                top -= 320;
            }
            _id("contextMenu").style.left = left + "px";
            _id("contextMenu").style.top = top + "px";
        })
        window.addEventListener("click", (event)=>{
            _id("contextMenu").classList.add("hidden");
            _id("contextMenu").style.display = "none";
        })

        let checkForUpdatesProceed = false;
        function checkForUpdates() {
            if (!checkForUpdatesProceed) {
                checkForUpdatesProceed = true;
                ipcRenderer.send("check-for-updates", true);
            }
            editTab.focus();
        }

        ipcRenderer.on("update-checked-result", (event, data)=>{
            checkForUpdatesProceed = false;
        })

        ipcRenderer.on("backup-documents", (event, data)=>{
            backUpProcess();
        })

        ipcRenderer.on("window-blurred", (event, data)=>{
            if (notefinity.autoSave) {
                saver.saveAll();
            }
        })
    </script>
</body>
</html>