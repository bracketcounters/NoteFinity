<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
            background: transparent;
        }
        *::-webkit-scrollbar-thumb {
            background: rgba(70, 70, 70, 0.2);
        }
        /* #editor {
            background: url(../../assets/images/background-grid.png), url(../../assets/images/background-gradient.png);
            background-position: center, center;
            background-size: contain, cover;
        } */
/* 		
        #editor {
            background: url(../assets/background.png);
            background-position: center;
            background-size: cover;
        }
		 */
    </style>
    <style id="configurableStyle"></style>
    <title>NoteFinity</title>
</head>
<body class="rounded-md select-none">
    <header class="w-full flex flex-col">
        <div class="flex justify-between items-center w-full h-8 px-2" id="headerPane" style="-webkit-app-region: drag;">

        </div>
        <ul class="w-full h-6 flex items-center justify-start" id="headerNavigation">
            <li class="navlist-item">
                <span>File</span>
                <ul class="navlist-sublist w-40 ml-1">
                    <li onclick="tabNewFile()">New (Ctrl+N)</li>
                    <li onclick="fileAction('openfile')">Open (Ctrl+O)</li>
                    <li>Open Folder</li>
                    <li>Open Recent Files</li>
                    <li>Save (Ctrl+S)</li>
                    <li>Save As (Ctrl+Shift+S)</li>
                    <li>Save All</li>
                    <hr>
                    <li>Quick Export</li>
                    <hr>
                    <li>Rename</li>
                    <hr>
                    <li>Close (Ctrl+W)</li>
                    <li>Close All</li>
                    <li>Close All but Active Document</li>
                    <li>Close All to the left</li>
                    <li>Close All to the right</li>
                    <hr>
                    <li>Exit</li>
                </ul>
            </li>
            <li class="navlist-item">
                <span>Edit</span>
                <ul class="navlist-sublist w-32">
                    <li onclick="notefinity.aceEditors[notefinity.activatedEditor].undo()">Undo (Ctrl+Z)</li>
                    <li onclick="notefinity.aceEditors[notefinity.activatedEditor].redo()">Redo (Ctrl+Y)</li>
                    <li>Time/Date (F5)</li>
                </ul>
            </li>
            <li class="navlist-item">
                <span>View</span>
                <ul class="navlist-sublist w-32">
                    <li onclick="toggleWordWrap()">Word Wrap</li>
                </ul>
            </li>
            <li class="navlist-item">
                <span>Options</span>
                <ul class="navlist-sublist w-32">
                    <li>Programming Language</li>
                    <li>Encrypt File</li>
                </ul>
            </li>
            <li class="navlist-item">
                <span>Customization</span>
                <ul class="navlist-sublist w-32">
                    <li onclick="openModal('frame')">Frame</li>
                    <li onclick="openModal('theme')">Theme</li>
                    <li onclick="openModal('textbox')">Textbox</li>
                </ul>
            </li>
            <li class="navlist-item"><span>Help</span></li>
        </ul>
    </header>
    <div id="editorList">
        <!-- <div class="editor absolute w-full top-14 bottom-7 left-0 right-0 outline-0"></div> -->
    </div>
    <div class="w-full h-7 flex items-start justify-start fixed bottom-0 px-1 overflow-hidden whitespace-nowrap overflow-x-auto tabscroll" id="tabscroll">
        <!-- <div class="tabitem tabitem-active">Untitled <span class="tabitem-close">&times;</span></div> -->
    </div>
    <script src="../../assets/js/ace.js"></script>
    <script src="../../assets/js/compulsory.js"></script>
    <script src="../../assets/js/framecomponents.js"></script>
    <script src="../../assets/js/themes.js"></script>
    <script src="../../assets/js/htmlrootclasses.js"></script>
    <script src="../../assets/js/idb.min.js"></script>
    <script src="../../assets/js/extensions.js"></script>
    <script>
    
        const fdb = new IndexedDBDatabase("filestore");
        const objectStore = "filestore";
        fdb.objectStore = objectStore;
        fdb.createObjectStore(objectStore, "sno", false, {
            filepath: "",
            contents: null,
        }, null).then(response=>{
            fdb.delete(1);
        });

        const tabscroll = document.getElementById("tabscroll");

        tabscroll.addEventListener("wheel", (e)=>{
            if (e.deltaY > 0) {
                tabscroll.scrollLeft += 20;
            }
            else {
                tabscroll.scrollLeft -= 20;
            }
        })


        class Editor {
            constructor() {
                this.updateEditorElements();
                this.aceEditors = [];
                this.activatedEditor = 0;
                this.wordWrap = true;
                this.untitledCount = 0;
                let notedata = localStorage.getItem("notedata");
                if (notedata == null) {
                    this.noteData = [];
                }
                else {
                    this.noteData = JSON.parse(notedata);
                }
                
            }
            initiate() {
                this.aceEditors = [];
                this.editorElements.forEach(element=>{
                    let editor = ace.edit(element, {
                        theme: "ace/theme/chrome",
                        fontSize: "16px",
                        showPrintMargin: false,
                    });
                    this.aceEditors.push(editor);
                    editor.session.setUseWrapMode(this.wordWrap);
                    setTimeout(() => {
                        editor.addEventListener("input", ()=>{
                            fileChangeReflected(this.activatedEditor);
                        })
                    }, 200);
                })
            }
            updateEditorElements() {
                this.editorElements = document.querySelectorAll(".editor");
                this.initiate();
            }

            add(text="", filepath=null, mode="text") {
                let div = document.createElement("div");
                div.setAttribute("class", "editor absolute w-full top-14 bottom-7 left-0 right-0 outline-0");
                _id("editorList").appendChild(div);
                this.updateEditorElements();

                let filename = "Untitled";
                let insertNoteData = {
                    "filepath": null,
                    "contents": "",
                    "changes": false,
                }
                if (filepath == null) {
                    filename = "Untitled";
                    this.untitledCount++;
                } else {
                    filename = filenameOf(filepath);
                    insertNoteData.filepath = filepath;
                    insertNoteData.contents = text;
                }
                this.noteData.push(insertNoteData);

                let tabitem = document.createElement("div");
                tabitem.setAttribute("class", "tabitem");
                if (filepath == null) {
                    tabitem.innerHTML = `<span class="tabitem-star hidden">*</span> <span class="tabitem-filename">${filename}-${this.untitledCount}</span> <span onclick="tabitemClose(${this.editorElements.length-1})" class="tabitem-close">&times;</span></div>`;
                }
                else {
                    tabitem.innerHTML = `<span class="tabitem-star hidden">*</span> <span class="tabitem-filename">${filename}</span> <span onclick="tabitemClose(${this.editorElements.length-1})" class="tabitem-close">&times;</span></div>`;
                }

                let tabitemListen = document.querySelectorAll(".tabitem").length;
                
                tabitem.onclick = (event) => {
                    if (event.target.getAttribute("class") != "tabitem-close") {
                        this.activateTab(tabitemListen);
                    }
                }

                _id("tabscroll").appendChild(tabitem);
                tabitem.click();
                refreshTextboxTheme();
                this.aceEditors[this.aceEditors.length-1].insert(text);
                this.aceEditors[this.aceEditors.length-1].session.setMode(`ace/mode/${mode}`);
            }
            
            activateTab(index) {
                this.activatedEditor = index;
                this.editorElements.forEach(element=>{
                    element.style.display = "none";
                })

                this.editorElements[index].style.display = "block";
                
                document.querySelectorAll(".tabitem").forEach(element=>{
                    element.classList.remove("tabitem-active");
                })
                document.querySelectorAll(".tabitem")[index].classList.add("tabitem-active");
                refreshTheme();
                this.aceEditors[index].focus();
                try {
                    let star = "";
                    if (_cls("tabitem-filename")[index].parentElement.getElementsByClassName("tabitem-star")[0].className.indexOf("hidden") == -1) {
                        star = "*";
                    }
                    _id("fileNoteFinityStatus").innerHTML = star + _cls("tabitem-filename")[index].innerHTML;
                }
                catch(err) {}
            }

        }

        const notefinity = new Editor();

        if (document.querySelectorAll(".tabitem").length <= 0) {
            notefinity.add();
        }


        const {ipcRenderer} = require("electron");

        function appAction(action) {
            if (action == "exit") {
                ipcRenderer.send("appAction", action);
            }
            else {
                ipcRenderer.send("appAction", action);
            }
        }

        document.addEventListener("keydown", function(event) {
            if (event.ctrlKey && event.key === "r") {
                event.preventDefault();
            }
            if (event.ctrlKey && event.shiftKey && event.key === "s") {
                event.preventDefault();
            }
            if (event.ctrlKey && event.key == "o") {
                fileAction("openfile");
            }
            if (event.ctrlKey && event.key == "n") {
                tabNewFile();
            }
            if (event.ctrlKey && event.key == "w") {
                event.preventDefault();
                tabitemClose(notefinity.activatedEditor);
            }
            if (event.ctrlKey && event.key == "Tab") {
                console.log("CTRL+Tab Pressed");
            }
        });

        function openModal(modal) {
            // editor.focus();
            ipcRenderer.send("open-modal", modal);
        }

        function extensionOf(filename) {
            const parts = filename.split('.');
            if (parts.length == 1) {
            return '';
            }
            return parts.pop();
        }

        function filenameOf(filepath) {
            let parts = filepath.split("/");
            if (filepath.indexOf("\\") != -1) {
                parts = filepath.split("\\");
            }
            else {
                parts = filepath.split("/");
            }
            return parts[parts.length-1];
        }



        function checkCustomizationFrame() {
            let customizationFrameData = localStorage.getItem("customizationNavigation");

            if (customizationFrameData != null) {
                customizationFrameData = JSON.parse(customizationFrameData);
                getHeader(customizationFrameData.alignment, customizationFrameData.navigationPane);

                if (customizationFrameData.navigationPane == 3) {
                    _cls("panel-round-exit")[0].style.background = customizationFrameData.colors.close;
                    _cls("panel-round-minimize")[0].style.background = customizationFrameData.colors.minimize;
                    _cls("panel-round-maximize")[0].style.background = customizationFrameData.colors.maximize;
                }
            }
            else {
                getHeader("nba", 3);
            }

        }
        ipcRenderer.on("check-customization-frame-check", (event, data)=>{
            checkCustomizationFrame();
        })
        
        checkCustomizationFrame();

        function refreshTheme() {
            let themeData = localStorage.getItem("activeTheme");
            if (themeData != null) {
                themeData = JSON.parse(themeData);
            }
            else {
                themeData = themes["Icy Blue"];
            }
            document.body.className = rootClasses.body + " " + themeData.playground;
            _id("tabscroll").className = rootClasses["#tabscroll"] + " " + themeData.playground;
            try {
                document.getElementsByClassName("tabitem-active")[0].className = rootClasses[".tabitem-active"] + " " + themeData.tabactive;
            }
            catch(err) {

            }
            _elms(".navlist-sublist li").forEach(element => {
                element.className = rootClasses[".navlist-sublist li"] + " " + themeData.navigationList;
            });
            _cls("navlist-item").forEach(element => {
                element.className = rootClasses[".navlist-item"] + " " + themeData.navigation;
            });
        }
        
        ipcRenderer.on("check-theme-check", (event, data)=>{
            refreshTheme();
        })
        refreshTheme();

        function refreshTextboxTheme() {
            let textboxThemeData = localStorage.getItem("activeTextBoxTheme");
            let textBoxThemeID = "chrome";
            let textBoxThemeImage = false;
            let textBoxGrid = true;
            if (textboxThemeData != null) {
                textboxThemeData = JSON.parse(textboxThemeData);
                textBoxThemeID = textboxThemeData.theme;
                if (textBoxThemeID == "chrome") {
                    textBoxThemeImage = textboxThemeData.image;
                    textBoxGrid = textboxThemeData.grid;
                }
            }
            else {
                textBoxThemeID = "chrome";
                textBoxThemeImage = "../../assets/images/background-gradient.png";
                textBoxGrid = true;
            }

            notefinity.aceEditors.forEach(editor=>{
                editor.setTheme(`ace/theme/${textBoxThemeID}`);
            })

            if (textBoxThemeImage != false) {
                if (textBoxGrid) {
                    _id("configurableStyle").innerHTML = `.editor {
                        background: url(../../assets/images/background-grid.png), url(${textBoxThemeImage});
                        background-position: center, center;
                        background-size: contain, cover;
                    } `;
                }
                else {
                    _id("configurableStyle").innerHTML = `.editor {
                        background: url(${textBoxThemeImage});
                        background-position: center;
                        background-size: cover;
                    } `;
                }
            }
            else {
                _id("configurableStyle").innerHTML = "";
            }
        }

        ipcRenderer.on("check-textbox-theme-check", (event, data)=>{
            refreshTextboxTheme();

        })
        refreshTextboxTheme();

        function tabNewFile() {
            notefinity.add();
        }

        function tabitemClose(index) {
            if (notefinity.editorElements.length == 1) {
                if (_cls("tabitem-star")[0].className.indexOf("hidden") == -1) {
                    confirmModal("Close without saving? Data will be lost.").then(response=>{
                        if (response) {
                            appAction("exit");
                            notefinity.noteData.splice(index, 1);
                        }
                    })
                }
                else {
                    appAction("exit");
                }
            }
            else {
            if (_cls("tabitem-star")[index].className.indexOf("hidden") == -1) {
                confirmModal("Close without saving? Data will be lost.").then(response=>{
                    if (response) {
                        notefinity.noteData.splice(index, 1);
                        let noteElement = notefinity.editorElements[index];
                        noteElement.remove();

                        document.querySelectorAll(".tabitem")[index].remove();
                        let tabitemCloseIcons = document.querySelectorAll(".tabitem-close");
                        
                        for (let i=0; i<tabitemCloseIcons.length; i++) {
                            tabitemCloseIcons[i].setAttribute("onclick", `tabitemClose(${i}, this)`);
                        }
                        
                        let tabitems = document.querySelectorAll(".tabitem");
                        for (let j=0; j<tabitems.length; j++) {
                            tabitems[j].onclick = (event) => {
                                if (event.target.getAttribute("class") != "tabitem-close") {
                                    notefinity.activateTab(j);
                                }
                            }
                        }
                        notefinity.updateEditorElements();
                        try {
                            tabitems[index-1].click();
                        }
                        catch(err) {
                            try {
                                tabitems[tabitems.length-1].click();
                            }
                            catch(err) {}
                        }
                    }
                    else {
                        return;
                    }
                })
            }
            else {
                notefinity.noteData.splice(index, 1);
                let noteElement = notefinity.editorElements[index];
                noteElement.remove();

                document.querySelectorAll(".tabitem")[index].remove();
                let tabitemCloseIcons = document.querySelectorAll(".tabitem-close");
                
                for (let i=0; i<tabitemCloseIcons.length; i++) {
                    tabitemCloseIcons[i].setAttribute("onclick", `tabitemClose(${i}, this)`);
                }
                
                let tabitems = document.querySelectorAll(".tabitem");
                for (let j=0; j<tabitems.length; j++) {
                    tabitems[j].onclick = (event) => {
                        if (event.target.getAttribute("class") != "tabitem-close") {
                            notefinity.activateTab(j);
                        }
                    }
                }
                notefinity.updateEditorElements();
                try {
                    tabitems[index-1].click();
                }
                catch(err) {
                    try {
                        tabitems[tabitems.length-1].click();
                    }
                    catch(err) {}
                }
            }
        }
        }

        function fileAction(action) {
            if (action == "openfile") {
                ipcRenderer.send("fileAction", "openfile");
            }
        }

        ipcRenderer.on("back-openFile", (event, data)=>{
            ipcRenderer.send("getFileContents", data);
        })

        ipcRenderer.on("back-getFileContents", (event, data)=>{
            let languageMode = "text";
            try {
                languageMode = extensionModes[extensionOf(data.filepath)];
            }
            catch(err) {
                if (err) {
                    languageMode = "text";
                }
            }
            notefinity.add(data.contents, data.filepath, languageMode);
        }) 

        function toggleWordWrap() {
            if (notefinity.wordWrap) {
                notefinity.wordWrap = false;
            }
            else {
                notefinity.wordWrap = true;
            }
            notefinity.updateEditorElements();
        }
        
        function fileChangeReflected(index) {
            _cls("tabitem-star")[index].classList.remove("hidden");
            try {
                    _id("fileNoteFinityStatus").innerHTML = "*" + _cls("tabitem-filename")[index].innerHTML;
                    notefinity.noteData[index].changes = true;
                }
            catch(err) {}
        }

    

    </script>
</body>
</html>